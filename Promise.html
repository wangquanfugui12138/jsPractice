<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Promise</title>
</head>

<body>
    <script>
        function Promise(fn) {
            var state = 'pending',
                value = null,
                callbacks = []

            this.then = function (onFulfilled, onRejected) {
                return new Promise(function (resolve, reject) {
                    handle({
                        onFulfilled: onFulfilled || null,
                        onRejected: onRejected || null,
                        resolve: resolve,
                        reject: reject
                    })
                })
            }

            function handle(callback) {
                if (state === 'pending') {
                    callbacks.push(callback)
                    return
                }

                var cb = state === 'fulfilled' ? callback.onFulfilled : callback.onRejected,
                    ret
                if (cb === null) {
                    cb = state === 'fulfilled' ? callback.resolve : callback.reject
                    cb(value)
                    return
                }
                ret = cb(value)
                callback.resolve(ret)
            }

            function resolve(newValue) {
                if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
                    var then = newValue.then
                    if (typeof then === 'function') {
                        then.call(newValue, resolve, reject)
                        return
                    }
                }
                state = 'fulfilled'
                value = newValue
                execute()
            }

            function reject(reason) {
                state = 'rejected'
                value = reason
                execute()
            }

            function execute() {
                setTimeout(function () {
                    callbacks.forEach(function (callback) {
                        handle(callback)
                    })
                }, 0)
            }

            fn(resolve, reject)
        }
        const p = function () {
            return new Promise((res, rej) => {
                setTimeout(() => {
                    document.write('<div style="color:red">Promise succeed!</div>')
                    res('Promise succeed!')
                }, 2000)
            })
        }
        function test() {
            const r = p().then(r => console.log(r))

        }
        test()
        console.log('hahahhahahahah')
    </script>
    <script>
        //es6 简易Promise
        class Promise {
            constructor(fn) {
                this.state = 'pending'
                this.value = undefined
                this.reason = undefined
                // 成功方法数组
                this.onResolvedCallbacks = []
                // 失败方法数组
                this.onRejectedCallbacks = []
                let resolve = value => {
                    if (this.state === 'pending') {
                        this.state = 'fulfilled'
                        this.value = value
                        this.onResolvedCallbacks.forEach(cb => cb())
                    }
                }
                let reject = reason => {
                    if (this.state === 'pending') {
                        this.state = 'rejected'
                        this.reason = reason
                        this.onRejectedCallbacks.forEach(cb => cb())
                    }
                }
                try {
                    fn(resolve, reject)
                } catch (err) {
                    reject(err)
                }
            }
            then(onFulfilled, onRejected) {
                if (this.state === 'fulfilled') {
                    onFulfilled(this.value)
                }
                if (this.state === 'rejected') {
                    onRejected(this.reason)
                }
                if (this.state === 'pending') {
                    this.onResolvedCallbacks.push(() => {
                        onFulfilled(this.value)
                    })
                    this.onRejectedCallbacks.push(() => {
                        onRejected(this.reason)
                    })
                }
            }
        }

        const p = function () {
            return new Promise((res, rej) => {
                setTimeout(() => {
                    document.body.innerHTML = '<div style="color:red">Promise succeed!</div>'
                    res('Promise succeed!')
                }, 2000)
            })
        }
        p().then(val => console.log(val))
    </script>
</body>

</html>